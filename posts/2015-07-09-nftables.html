<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>bgamari.github.com - A simple nftables firewall</title>
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </head>
  <body>
    <div id="container">
      <div id="content">
        <div id="sidebar">
          <nav>
            <h1>Navigation</h1>
            <ul>
              <li><a href="../index.html">Home</a></li>
              <li><a href="../posts.html">Blog</a></li>
              <li><a href="../research-agenda.html">Research agenda</a></li>
              <li><a href="../publications.html">Publications</a></li>
              <li><a href="../past-research.html">Past research</a></li>
              <li><a href="../media/cv.pdf">Curriculum Vitæ</a></li>
            </ul>
            <h1>Related Links</h1>
            <ul>
              <li><a href="http://goldnerlab.physics.umass.edu/wiki/">Research group</a></li>
              <li><a href="http://www.github.com/bgamari">Github</a></li>
            </ul>
          </nav>
        </div>

        <section id="main">
        <article>
    <h1>A simple nftables firewall</h1>
    <header>
        <div class="meta">
            <time datetime="2015-07-09" class="pubdate">2015-07-09</time> | tagged with <ul class="tags"><li>firewall</li><li>linux</li></ul>
        </div>
    </header>

    <h1 id="a-simple-nftables-firewall-with-nat">A simple nftables firewall with NAT</h1>
<p><code>nftables</code> is the successor to <code>iptables</code> as the Linux firewall. It carries with it a number of advantages, not the least of which being a very nice syntax which essentially eliminates the need for code generation (in contrast to iptables, where code generation was generally quite necessary).</p>
<p>Unfortunately, nftables is still quite new and as such documentation is a bit lacking. A few weeks ago I spent a couple of hours porting my simple iptables chains to nftables. Here is the result,</p>
<pre><code>#!/usr/bin/local/nft -f 

flush ruleset

define ext_if = eth1
define lan_if = eth0
define wlan_if = wlan0
define int_ifs = { $lan_if, $wlan_if }
define services = { http, 3000, 8080, 9001, 6881-6899, 22, 6697 }

table ip filter {
  chain input {
    type filter hook input priority 0
    meta iif lo accept
    ct state invalid log prefix &quot;[BLOCK] invalid packet: &quot; drop
    tcp dport $services accept
    udp dport $services accept
    ip daddr 224.0.0.251 udp dport mdns accept
    meta iif $int_ifs accept
    ip protocol icmp accept
    ct state related,established accept
    log prefix &quot;[BLOCK] denied packet: &quot; drop
  }

  chain output {
    type filter hook output priority 0;
    ct state related, established accept;
    accept;
  }

  chain forward {
    type filter hook forward priority 0;
    accept;
  }
}

# The first packet in each flow will hit this table; none others will
table ip nat {
  chain postrouting {
    type nat hook postrouting priority 0;
    ip saddr 192.168.0.0/16 oif $ext_if masquerade
  }

  chain prerouting {
    type nat hook prerouting priority 0;
    iif $ext_if tcp dport 808 dnat 192.168.2.130:8080
    iif $ext_if tcp dport 5001 dnat 192.168.2.130:5000
  }
}</code></pre>
<p>Note that this requires a recent kernel and userspace tools. If things don’t work right off the bat, be sure to double-check your kernel configuration. I spent a great deal of time chasing down vague errors due to missing modules.</p>
</article>

        </section>
      </div>

      <footer id="footer">
        <span>Generated by <a href="http://jaspervdj.be/hakyll/index.html">Hakyll</a>.</span>
      </footer>
    </div>
  </body>
</html>

