<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>bgamari.github.com - Using perf probe for fun and profit</title>
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </head>
  <body>
    <div id="container">
      <div id="content">
        <div id="sidebar">
          <nav>
            <h1>Navigation</h1>
            <ul>
              <li><a href="../index.html">Home</a></li>
              <li><a href="../posts.html">Blog</a></li>
              <li><a href="../research-agenda.html">Research agenda</a></li>
              <li><a href="../publications.html">Publications</a></li>
              <li><a href="../past-research.html">Past research</a></li>
              <li><a href="../media/cv.pdf">Curriculum Vitæ</a></li>
            </ul>
            <h1>Related Links</h1>
            <ul>
              <li><a href="http://goldnerlab.physics.umass.edu/wiki/">Research group</a></li>
              <li><a href="http://www.github.com/bgamari">Github</a></li>
            </ul>
          </nav>
        </div>

        <section id="main">
        <article>
    <h1>Using perf probe for fun and profit</h1>
    <header>
        <div class="meta">
            <time datetime="2015-01-06" class="pubdate">2015-01-06</time> | tagged with <ul class="tags"><li>gtk</li><li>perf</li></ul>
        </div>
    </header>

    <p>Gnome Terminal has for a long time now exhibited a peculiar and annoying tendency to leak X11 resources. Over the course of weeks it will accrue hundreds of thousands of resources which <code>xrestop</code> could only describe as “Miscellaneous”. Eventually I broke down and found that these are <code>SyncCounters</code>. The challenge was then to determine why this was happening.</p>
<p>A bit of poking around in <code>gdb</code> indicated that <code>gnome-terminal-server</code> calls <code>XSyncCreateCounter</code> and <code>XSyncDestroyCounter</code> are when one would roughly expect (namely window creation and destruction). So where is this leak coming from?</p>
<p>The obvious way to approach this is be to capture callgraphs to calls to these functions and see if we can find missing frees. It turns out that <code>perf</code> has just the tool for this task: <code>perf probe</code>.</p>
<pre><code>$ sudo chown ben /sys/kernel/debug -R
$ ~/bin/perf probe  -x /usr/lib/x86_64-linux-gnu/libXext.so --add XSyncCreateCounter
$ ~/bin/perf probe  -x /usr/lib/x86_64-linux-gnu/libXext.so --add XSyncDestroyCounter
~/bin/perf record -e probe_libXext:XSyncCreateCounter,probe_libXext:XSyncDestroyCounter /usr/lib/gnome-terminal/gnome-terminal-server</code></pre>
<p>This lead to the opening (and, happily, resolution) of Gnome ticket <a href="https://bugzilla.gnome.org/show_bug.cgi?id=760188">#760188</a>.</p>
</article>

        </section>
      </div>

      <footer id="footer">
        <span>Generated by <a href="http://jaspervdj.be/hakyll/index.html">Hakyll</a>.</span>
      </footer>
    </div>
  </body>
</html>

