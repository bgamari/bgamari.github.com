<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>bgamari.github.com - SWD with OpenOCD and a Bus Blaster</title>
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
  </head>
  <body>
    <div id="content">
      <div id="sidebar">
        <nav>
          <h1>Navigation</h1>
          <ul>
            <li><a href="../index.html">Home</a></li>
            <li><a href="../posts.html">Blog-like thing</a></li>
            <li><a href="../research-agenda.html">Research agenda</a></li>
            <li><a href="../publications.html">Publications</a></li>
            <li><a href="../past-research.html">Past research</a></li>
            <li><a href="../media/cv.pdf">Curriculum Vitæ</a></li>
          </ul>
          <h1>Related Links</h1>
          <ul>
            <li><a href="http://goldnerlab.physics.umass.edu/wiki/">Research group</a></li>
            <li><a href="http://www.github.com/bgamari">Github</a></li>
          </ul>
        </nav>
      </div>

      <section id="main">
      <h1 id="swd-with-openocd-and-a-bus-blaster">SWD with OpenOCD and a Bus Blaster</h1>
<p>For a while now OpenOCD has had some support for Serial Wire Debug (SWD). SWD is an alternative to the JTAG wire protocol and has the advantage of requiring only two IO pins (data and clock), power, and ground (as opposed two JTAG’s four data pins, two resets, power, and ground).</p>
<p>Unfortunately, the <a href="http://openocd.sourceforge.net/doc/html/Debug-Adapter-Configuration.html#Debug-Adapter-Configuration">documentation</a> surrounding OpenOCD’s SWD implementation is a bit sparse. This afternoon I finally grew frustrated with the mess of wires required by JTAG and forged ahead into OpenOCD’s SWD support.</p>
<p>The target in this case in my <a href="https://github.com/bgamari/solar-charger-v2">solar battery charger</a> which has an STM32L151 microcontroller. The adapter is a Bus Blaster v3.</p>
<p>The first step was to flash the Bus Blaster’s CPLD with a KT-link buffer. While Dangerous Prototypes’s <a href="https://code.google.com/p/dangerous-prototypes-open-hardware/source/browse/#svn%2Ftrunk%2FBus_Blaster%2Fbuffer_logic">repository</a> only contains sources for Bus Blaster v2, Ben Harris has a <a href="https://github.com/bharrisau/busblaster">convenient implementation</a> for the v3 hardware complete with SVF bitcode. Flashing the buffer is easily accomplished with OpenOCD, as <a href="http://bgamari.github.io/posts/2013-07-24-flashing-busblaster-cpld-with-openocd.html">documented previously</a>,</p>
<pre><code>$ git clone https://github.com/bharrisau/busblaster.git
$ cd busblaster/synthesis
$ openocd -f board/dp_busblaster_v3.cfg -c &quot;adapter_khz 1000; init; svf system.svf; shutdown&quot;</code></pre>
<p>At this point I consulted the <a href="https://github.com/ntfreak/openocd/blob/master/tcl/interface/ftdi/swd-resistor-hack.cfg">SWD resistor hack</a> that the incredibly helpful <code>PaulFertser</code> once referred me to on <code>#openocd</code>. This describes the connections necessary for SWD with an FTDI-based adapter like the Bus Blaster,</p>
<pre><code>     adapter                      target

     TCK ──────────────────────── SWDCK
     
     TDO ────────────────┬─────── SWDIO
                         │
     TDI ──────/\/\/\/───┘
               220 ohm</code></pre>
<p>Now it’s simply a matter of a little configuration,</p>
<pre><code>$ cat &gt;openocd-swd.cfg &lt;&lt;EOF
# BusBlaster with KT-link
# This is just interface/ftdi/busblaster.cfg
interface ftdi
ftdi_vid_pid 0x0403 0x6010
ftdi_layout_init 0x8c28 0xff3b
ftdi_layout_signal nTRST -data 0x0100 -noe 0x0400
ftdi_layout_signal nSRST -data 0x0200 -noe 0x0800

source [find interface/ftdi/swd-resistor-hack.cfg]
transport select swd
reset_config none
source [find target/stm32l.cfg]
EOF</code></pre>
<p>And voila,</p>
<pre><code>$ openocd -f openocd-swd.cfg 
Open On-Chip Debugger 0.9.0-dev-00141-g11db2c2 (2014-08-23-14:32)
Licensed under GNU GPL v2
For bug reports, read
	http://openocd.sourceforge.net/doc/doxygen/bugs.html
Info : FTDI SWD mode enabled
none separate
adapter speed: 300 kHz
adapter_nsrst_delay: 100
cortex_m reset_config sysresetreq
Info : clock speed 300 kHz
Info : SWD IDCODE 0x2ba01477
Info : stm32l.cpu: hardware has 6 breakpoints, 4 watchpoints</code></pre>
<h2 id="related-resources">Related resources</h2>
<ul>
<li>the <a href="http://www.mchck.org/">MC HCK</a> project’s <a href="https://github.com/mchck/programmer">programmer</a> has a nice SWD implementation written in Ruby which supports both the Bus Pirate and the Bus Blaster</li>
</ul>
      </section>
    </div>

    <footer id="footer">
      <span>Generated by <a href="http://jaspervdj.be/hakyll/index.html">Hakyll</a>.</span>
    </footer>
  </body>
</html>

