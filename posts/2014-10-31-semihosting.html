<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>bgamari.github.com - Semihosting on ARM with GCC and OpenOCD</title>
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </head>
  <body>
    <div id="container">
      <div id="content">
        <div id="sidebar">
          <nav>
            <h1>Navigation</h1>
            <ul>
              <li><a href="../index.html">Home</a></li>
              <li><a href="../posts.html">Blog</a></li>
              <li><a href="../research-agenda.html">Research agenda</a></li>
              <li><a href="../publications.html">Publications</a></li>
              <li><a href="../past-research.html">Past research</a></li>
              <li><a href="../media/cv.pdf">Curriculum Vitæ</a></li>
            </ul>
            <h1>Related Links</h1>
            <ul>
              <li><a href="http://goldnerlab.physics.umass.edu/wiki/">Research group</a></li>
              <li><a href="http://www.github.com/bgamari">Github</a></li>
            </ul>
          </nav>
        </div>

        <section id="main">
        <article>
    <h1>Semihosting on ARM with GCC and OpenOCD</h1>
    <header>
        <div class="meta">
            <time datetime="2014-10-31" class="pubdate">2014-10-31</time> | tagged with <ul class="tags"><li>openocd</li><li>gdb</li><li>gcc</li><li>arm</li></ul>
        </div>
    </header>

    <h1 id="semihosting-with-arm-gcc-and-openocd">Semihosting with ARM, GCC, and OpenOCD</h1>
<p>One of the many nice features of the ARM Cortex microcontrollers is the ability to use the JTAG debug interface as a sink for <code>printf</code> messages. This capability is known as <em>semihosting</em>. It’s actually quite straightforward to configure with open source tooling (the <a href="https://www.sourceware.org/newlib/"><code>newlib</code></a> C standard library and <a href="http://openocd.org/">OpenOCD</a> JTAG implementation).</p>
<p>You’ll need to add the following to <code>LDFLAGS</code>,</p>
<pre><code>LDFLAGS += --specs=rdimon.specs -lc -lrdimon</code></pre>
<p>Note that <code>librdimon</code> takes the place of <code>libnosys</code>.</p>
<p>Ensure that <code>initialise_monitor_handles()</code> is called in <code>main</code> before calling <code>printf</code>,</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">extern</span> <span class="dt">void</span> initialise_monitor_handles(<span class="dt">void</span>);</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="dt">int</span> main(<span class="dt">void</span>) {</span>
<span id="cb2-4"><a href="#cb2-4"></a>    initialise_monitor_handles();</span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a>    printf(<span class="st">&quot;hello world!</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="co">// do things</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>}</span></code></pre></div>
<p>If you are using the toolchain’s <code>crt0</code> initialization function then <code>initialise_monitor_handles</code> has already been called for you.</p>
<p>At runtime enable semihosting in OpenOCD with <code>arm semihosting enable</code> before <code>initialise_monitor_handles</code> is called. Failure to do this will result in a <code>HardFault</code> due to an unexpected debug event. Also be aware that semihosting is disabled on core reset. This effectively means that an image compiled with semihosting enabled will be unable to run in the absence of a debugger (unless you make the call to <code>initialise_monitor_handles</code> contingent on a runtime flag).</p>
<p>You should now see your <code>printf</code> messages show up in the OpenOCD console. You can</p>
<h2 id="resources">Resources</h2>
<ul>
<li>Very helpful guide by Andrey Yurovsky: https://plus.google.com/+AndreyYurovsky/posts/5rupuziHKGC</li>
<li>Original <code>openocd-devel</code> thread: http://thread.gmane.org/gmane.comp.debugging.openocd.devel/10941/focus=10958</li>
<li><code>libopencm3</code> example: https://github.com/libopencm3/libopencm3-examples/tree/master/examples/stm32/l1/stm32l-discovery/usart-semihosting</li>
<li>OpenOCD manual section (search for “semihosting”): http://openocd.sourceforge.net/doc/html/Architecture-and-Core-Commands.html#Architecture-and-Core-Commands</li>
</ul>
</article>

        </section>
      </div>

      <footer id="footer">
        <span>Generated by <a href="http://jaspervdj.be/hakyll/index.html">Hakyll</a>.</span>
      </footer>
    </div>
  </body>
</html>

